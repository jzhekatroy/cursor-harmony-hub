name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Generate Prisma Client
      run: npx prisma generate
        
    - name: Run Database Migrations
      run: npx prisma migrate deploy
        
    - name: Verify Database Schema
      run: npx prisma db push --accept-data-loss
        
    - name: Seed Database (if needed)
      run: npx prisma db seed
      continue-on-error: true
        
    - name: Build Application
      run: npm run build
        
    - name: Deploy to Production Server
      run: |
        echo "ğŸš€ Deploying to production server..."
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ SSH ĞºĞ»ÑÑ‡ Ğ¸Ğ· ÑĞµĞºÑ€ĞµÑ‚Ğ°
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts
        
        # ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ Ğº ÑĞµÑ€Ğ²ĞµÑ€Ñƒ Ğ¸ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ğ¼
        echo "ğŸ”„ Deploying on server..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
          cd /home/beautyapp/beauty-booking
          
          # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
          echo "â¹ï¸ Stopping application..."
          sudo pkill -f "npm start" || echo "App not running"
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          
          # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Prisma Client
          echo "ğŸ”§ Generating Prisma Client..."
          npx prisma generate
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
          echo "ğŸ”„ Running database migrations..."
          npx prisma migrate deploy
          
          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
          echo "ğŸ”¨ Building application..."
          sudo -u beautyapp npm run build
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
          echo "ğŸš€ Starting application..."
          sudo -u beautyapp nohup npm start > nohup.out 2>&1 &
          
          # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
          sleep 10
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ»Ğ¾ÑÑŒ
          if curl -f http://localhost:3000/api/status > /dev/null 2>&1; then
            echo "âœ… Application started successfully!"
          else
            echo "âŒ Application failed to start, checking logs..."
            tail -20 nohup.out
            exit 1
          fi
          
          echo "âœ… Deployment completed!"
        EOF
        
    - name: Health Check
      run: |
        echo "ğŸ” Running health check..."
        echo "âœ… Deployment completed successfully!"
        echo "ğŸŒ Check your production URL to verify"