name: ğŸš€ Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    # ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ (Ğ½Ğ¸Ğ¶Ğµ), Ğ³Ğ´Ğµ ĞµÑÑ‚ÑŒ .env Ñ DATABASE_URL
      
    - name: ğŸ”¨ Build application
      run: npm run build
      
    - name: ğŸ§ª Run tests (if any)
      run: npm test --if-present
      
    - name: ğŸ“¥ Update code on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "ğŸš€ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ..."
          
          # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
          cd /home/beautyapp/beauty-booking
          echo "ğŸ“‚ Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ: $(pwd)"
          
          echo "ğŸ“¥ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¸Ğ· GitHub..."
          git fetch origin
          git reset --hard origin/main
          echo "âœ… ĞšĞ¾Ğ´ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ´Ğ¾ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°: $(git rev-parse --short HEAD)"

          echo "ğŸ§¹ Ğ§Ğ¸ÑÑ‚Ğ¸Ğ¼ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ´ÑƒĞ±Ğ»Ğ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° (Ğ°Ñ€Ñ…Ğ¸Ğ²Ñ‹/Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸)..."
          [ -d beauty-booking-mvp ] && rm -rf beauty-booking-mvp || true

          echo "ğŸ› ï¸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ docker-compose.yml (Ğ±ĞµĞ· Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²; Ğ¿Ğ¾Ñ€Ñ‚Ñ‹/health ÑƒĞ¶Ğµ Ğ² Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸)"
          
          echo "ğŸ³ ĞŸĞ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Docker..."
          docker compose --env-file .env up -d postgres || true
          
          echo "ğŸ”¨ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Docker-Ğ¾Ğ±Ñ€Ğ°Ğ· Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ..."
          docker compose build --no-cache beauty-booking
          
          echo "ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· Docker..."
          docker compose --env-file .env up -d --remove-orphans beauty-booking
          
          echo "ğŸ—„ï¸ ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ (Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğµ) Ñ DATABASE_URL Ğ¸Ğ· .env Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ..."
          set -o allexport; source .env; set +o allexport
          docker compose exec -e DATABASE_URL="$DATABASE_URL" beauty-booking sh -lc 'npx prisma migrate deploy' || { echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹"; exit 1; }
          
          echo "ğŸ“Š Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²:" && docker compose ps
          
    # Docker ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ¼, Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ÑˆĞ°Ğ³ Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ
          
    - name: âœ… Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        timeout: 60s
        script: |
          echo "ğŸ” Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ´ĞµĞ¿Ğ»Ğ¾Ñ..."
          
          cd /home/beautyapp/beauty-booking
          
          # Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° health check
          echo "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ health check..."
          if curl -f http://127.0.0.1:3000/api/health > /dev/null 2>&1; then
            echo "âœ… Health check Ğ¿Ñ€Ğ¾ÑˆĞµĞ» ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!"
            echo "ğŸŒ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ½Ğ° http://test.2minutes.ru"
            echo "ğŸ‰ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!"
          else
            echo "âš ï¸ Health check Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑˆĞµĞ», Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½"
            echo "ğŸ“‹ Ğ›Ğ¾Ğ³Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ:"
            docker compose logs --tail=80 beauty-booking || true
            echo "ğŸ” Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ ĞµÑ‰Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ÑÑ..."
          fi
          
    - name: ğŸ“Š Deployment status
      if: success()
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸ”— Check: http://test.2minutes.ru"
        echo "ğŸ‘¤ Login: salon@example.com / password123"
        
    - name: âŒ Deployment failed
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo "Check the logs above for details"
