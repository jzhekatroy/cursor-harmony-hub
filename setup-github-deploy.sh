#!/bin/bash

echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° GitHub Ð´ÐµÐ¿Ð»Ð¾Ñ Ð´Ð»Ñ Beauty Booking"
echo "============================================="

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ðŸ“‹ Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚:${NC}"
echo "1. SSH ÐºÐ»ÑŽÑ‡Ð¸ Ð´Ð»Ñ GitHub"
echo "2. Git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹"
echo "3. GitHub Actions ÑÐµÐºÑ€ÐµÑ‚Ñ‹"
echo "4. ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹"
echo

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
if [[ ! -d "/home/beautyapp" ]]; then
    echo -e "${RED}âŒ Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð½ÑƒÐ¶Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ!${NC}"
    exit 1
fi

# ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
cd /home/beautyapp/beauty-booking || {
    echo -e "${RED}âŒ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ /home/beautyapp/beauty-booking Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!${NC}"
    exit 1
}

echo -e "${YELLOW}ðŸ”‘ Ð¨Ð°Ð³ 1: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ SSH ÐºÐ»ÑŽÑ‡ÐµÐ¹${NC}"
echo "=================================="

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ SSH ÐºÐ»ÑŽÑ‡ ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
if [[ ! -f ~/.ssh/id_rsa ]]; then
    echo "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ SSH ÐºÐ»ÑŽÑ‡..."
    ssh-keygen -t rsa -b 4096 -C "beautyapp@$(hostname)" -f ~/.ssh/id_rsa -N ""
    echo -e "${GREEN}âœ… SSH ÐºÐ»ÑŽÑ‡ ÑÐ¾Ð·Ð´Ð°Ð½${NC}"
else
    echo -e "${GREEN}âœ… SSH ÐºÐ»ÑŽÑ‡ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚${NC}"
fi

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡
echo
echo -e "${BLUE}ðŸ“‹ Ð’Ð°Ñˆ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ SSH ÐºÐ»ÑŽÑ‡ (ÑÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÐµÐ³Ð¾):${NC}"
echo "=================================================="
cat ~/.ssh/id_rsa.pub
echo "=================================================="
echo
echo -e "${YELLOW}âš ï¸  Ð’ÐÐ–ÐÐž: Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÑÑ‚Ð¾Ñ‚ ÐºÐ»ÑŽÑ‡ Ð² GitHub:${NC}"
echo "1. Ð˜Ð´Ð¸Ñ‚Ðµ Ð½Ð° github.com â†’ Settings â†’ SSH and GPG keys"
echo "2. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'New SSH key'"
echo "3. Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ»ÑŽÑ‡ Ð²Ñ‹ÑˆÐµ"
echo "4. Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ"
echo

read -p "Ð”Ð¾Ð±Ð°Ð²Ð¸Ð»Ð¸ SSH ÐºÐ»ÑŽÑ‡ Ð² GitHub? (y/N): " SSH_ADDED
if [[ $SSH_ADDED != "y" && $SSH_ADDED != "Y" ]]; then
    echo -e "${RED}âŒ Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ SSH ÐºÐ»ÑŽÑ‡ Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ½Ð¾Ð²Ð°${NC}"
    exit 1
fi

echo
echo -e "${YELLOW}ðŸ“¦ Ð¨Ð°Ð³ 2: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ${NC}"
echo "===================================="

read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ URL Ð²Ð°ÑˆÐµÐ³Ð¾ GitHub Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ (git@github.com:username/repo.git): " REPO_URL

if [[ -z "$REPO_URL" ]]; then
    echo -e "${RED}âŒ URL Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼${NC}"
    exit 1
fi

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ remote origin
if git remote get-url origin >/dev/null 2>&1; then
    echo "ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ origin..."
    git remote set-url origin "$REPO_URL"
else
    echo "Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ origin..."
    git remote add origin "$REPO_URL"
fi

# ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ð½Ð° main Ð²ÐµÑ‚ÐºÑƒ
git checkout -b main 2>/dev/null || git checkout main

echo -e "${GREEN}âœ… Git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½${NC}"

echo
echo -e "${YELLOW}ðŸš€ Ð¨Ð°Ð³ 3: ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ð¿ÑƒÑˆ Ð² GitHub${NC}"
echo "=============================="

# ÐŸÑƒÑˆÐ¸Ð¼ ÐºÐ¾Ð´ Ð² GitHub
echo "ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ Ð² GitHub..."
git push -u origin main

if [[ $? -eq 0 ]]; then
    echo -e "${GREEN}âœ… ÐšÐ¾Ð´ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ Ð² GitHub${NC}"
else
    echo -e "${RED}âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð² GitHub${NC}"
    echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:"
    echo "1. SSH ÐºÐ»ÑŽÑ‡ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð² GitHub"
    echo "2. URL Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹"
    echo "3. Ð£ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹"
    exit 1
fi

echo
echo -e "${YELLOW}ðŸ”§ Ð¨Ð°Ð³ 4: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´ÐµÐ¿Ð»Ð¾Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°${NC}"
echo "================================="

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
cat > deploy-from-github.sh << 'EOF'
#!/bin/bash

echo "ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¸Ð· GitHub"
echo "==================="

# ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo "â¸ï¸ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
sudo -u beautyapp pm2 stop beauty-booking

# Ð”ÐµÐ»Ð°ÐµÐ¼ git pull
echo "ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸Ð· GitHub..."
sudo -u beautyapp git pull origin main

if [[ $? -ne 0 ]]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹!"
    sudo -u beautyapp pm2 start beauty-booking
    exit 1
fi

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
sudo -u beautyapp npm install

# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo "ðŸ”¨ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
sudo -u beautyapp npm run build

if [[ $? -ne 0 ]]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸!"
    sudo -u beautyapp pm2 start beauty-booking
    exit 1
fi

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo "â–¶ï¸ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
sudo -u beautyapp pm2 restart beauty-booking

echo "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
echo "ðŸ”— ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ: http://test.2minutes.ru"
EOF

chmod +x deploy-from-github.sh
chown beautyapp:beautyapp deploy-from-github.sh

echo -e "${GREEN}âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½${NC}"

echo
echo -e "${GREEN}ðŸŽ‰ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!${NC}"
echo "======================="
echo
echo -e "${BLUE}ðŸ“‹ Ð§Ñ‚Ð¾ Ð´Ð°Ð»ÑŒÑˆÐµ:${NC}"
echo "1. Ð¢ÐµÐ¿ÐµÑ€ÑŒ ÑÐ¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ GitHub Actions (Ñ Ð¿Ð¾ÐºÐ°Ð¶Ñƒ ÐºÐ°Ðº)"
echo "2. ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹"
echo
echo -e "${BLUE}ðŸ”— ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:${NC}"
echo "â€¢ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ: ./deploy-from-github.sh"
echo "â€¢ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°: pm2 status"
echo "â€¢ Ð›Ð¾Ð³Ð¸: pm2 logs beauty-booking"